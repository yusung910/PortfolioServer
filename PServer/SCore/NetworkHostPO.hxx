/**
 *  @file NetworkHost.hxx
 *  @author YS
 *  @date 2024-10-17
 *  @project SCore
 *
 *  IOCP 통신에 사용될 host 
 *  Network Host -> 네트워크/인터넷을 통해 다른 컴퓨터들과 쌍방향 통신이 가능한 '컴퓨터(단말기)'
 *  다른 '컴퓨터(단말기)'와 통신 할 수 있는 '컴퓨터(단말기)'의 정보와 관련 함수가 정의 되어 있는 클래스
 *  서버 컴퓨터의 정보가 담긴 클래스
 *  https://lxxyeon.tistory.com/172
 *   
 *  NetworkContext의 Type별로 함수들이 존재한다(예외 Waiting)
 */
#pragma once
#include "BlockingQueue.h"
#include "NetworkCommon.h"
#include "PacketCompressor.hxx"
#include <array>

constexpr int ACCEPT_WAIT_COUNT = 100;

//Forward Declarations
class NetworkEventSync;
class NetworkContextPO;

constexpr size_t MAX_MESSAGE_ID_HISTORY_SIZE = 100;

class NetworkHostPO
{
private:

    //패킷 압축 관련 클래스
    PacketCompressor::SharedPtr m_pPacketCompressor = nullptr;

    int m_nHostID = 0;
    SOCKET m_oSocket = INVALID_SOCKET;
    
    //Host 유형
    EHostType m_eHostType = EHostType::None;

    //네트워크 통신 event 싱크를 맞추기 위한 클래스를 Pacade 형태로 이용
    NetworkEventSync* m_pEventSync = nullptr;

    //기초 작업 수
    volatile long m_lBaseTaskCount = 0;
    //전송 작업 수
    volatile long m_lSendTaskCount = 0;

    int64_t m_nCheckTimeoutMS = 0;
    int64_t m_nCheckAliveMS = 0;

    std::string m_sIP = "";

    int m_nIP = 0;
    int m_nPort = 0;

    std::mutex m_xSendLock;

    //패킷 전송 대기 목록
    std::deque<Packet::SharedPtr> m_oSendWaitingList;

    //전송 패킷 큐
    std::deque<Packet::SharedPtr> m_oSendWorkQueue;

    // 통신의 목적지가 클라이언트인지 여부
    // true : 클라이언트
    // false : 서버
    bool m_bIsClientHost = false;

    // 소켓이 종료(close)된 원인 코드
    ESocketCloseType m_eLastSocketCloseType = ESocketCloseType::Reset;

    //Packet History 패킷이 통신되는 이력을 관리하는 변수 목록
    const int64_t m_nPACKET_RECV_CHECK_TICK = 10000;
    const int64_t m_fPACKET_RECV_CHECK_COUNT_PER_SEC = 30.f;

    bool            m_bUsePacketRecvCheck = false;
    int64_t         m_nPacketRecvCheckTick = 0;
    std::atomic_int m_nPacketRecvCheckCounter = 0;
    
    std::atomic_int m_nMessageHistoryIdx = 0;
    std::array<std::tuple<int, int64_t>, MAX_MESSAGE_ID_HISTORY_SIZE> m_oMessageHistory = {};

    std::atomic_int64_t m_nLastPacketTick = 0;
    // Packet History End

public:
    /*!
     *  Constructor.
     *  m_pPacketCompressor 객체 생성
     */
    NetworkHostPO();

    /*!
     *  Destructor.
     *  Reset() 함수 호출
     */
    virtual ~NetworkHostPO();

    //NetworkHost 내부 멤버 변수들 초기화
    void Reset();

    /*!
     *  m_lBaseTaskCount 값을 증가한다.
     */
    void BeginBaseTask();
    

    /*!
     *  기본 task 종료처리.
     */
    void EndBaseTask(bool _rslt, const ESocketCloseType& _type = ESocketCloseType::FailedToBaseTask);

    /*!
     *  Begins the send task.
     */
    void BeginSendTask();

    /*!
     *  네트워크 호스트 task 전송 종료처리
     *
     *      @param [in] _rslt If true, rslt. Otherwise not rslt.
     */
    void EndSendTask(bool _rslt);

    //EContextType 별 함수 목록
    //enum class EContextType : int
    //{
    //    None = 0,
    //    Listen,
    //    Join,
    //    Accept,
    //    Connect,
    //    Receive,
    //    Send,
    //    Encrypt,
    //    Close,
    //};

    /*!
     *  NetworkContext를 참조형 변수로 전달 받아
     *  소켓 통신을 하기 위해 WSAIoctl()로 Connect한다
     *  NetworkContextPO의 참조 수 (ReferenceCount)를 증가한다
     *
     *  NetworkContext로 소켓을 통신 할 수 있는 상태로 만든다
     *      @param [in,out] NetworkContextPO& _ctxt 
     *
     *      @return 
     */
    bool Connect(NetworkContextPO& _ctxt);

    /*!
     *  소켓의 상태를 listen()로 수신 대기 상태로 지정한다
     *
     *      @return 
     */
    bool Listen();

    /*!
     *  클라이언트와의 연결을 수락하고 로컬주소와 원격 주소를 반환한다
     *  AcceptEx(), GetAcceptExSockaddrs() 이용
     *      @param [in,out] _ctxt 
     *
     *      @return 
     */
    bool Accept(NetworkContextPO& _ctxt);

    /*!
     *  소켓에 접속한 클라이언트에 WSARecv()로 NetworkContext 데이터를 보낸다
     *  데이터를 보낸 결과를 NetworkContextPO _ctxt에 기록한다
     *      @param [in,out] _ctxt 
     *
     *      @return 
     */
    bool Receive(NetworkContextPO& _ctxt);
    /*!
     *  NetworkContext에 저장된 데이터를 복호화한다
     *  복호화 후 Receive(NetworkContextPO& _ctxt)를 실행한다
     *      @param [in,out] _ctxt 
     *
     *      @return 
     */
    bool Decrypt(NetworkContextPO& _ctxt);

    /*!
     *  전송 대기 목록(m_oSendWaitingList)에 패킷을 추가하는 함수
     *
     *      @param [in] _packt 
     *
     *      @return 
     */
    bool Waiting(Packet::SharedPtr _packt);

    /*!
     *  패킷 암호화
     *  m_oSendWaitingList에 있는 전송 대기 패킷 목록을
     *  m_oSendWorkQueue에 이동(swap)하고 
     *  NetworkContext에 기록(write)한다
     *      @param [in,out] _ctxt 
     *
     *      @return 
     */
    bool Encrypt(NetworkContextPO& _ctxt);

    /*!
     *  NetworkContext에 저장된 데이터를 송신한다
     *
     *      @param [in,out] _ctxt 
     *
     *      @return 
     */
    bool Send(NetworkContextPO& _ctxt);

    bool Close(ESocketCloseType _e);
    //

    /*!
     *  서버 통신 가능 상태 확인
     *
     *      @return True if alive. False if not.
     */
    bool IsAlive();

    //네트워크 상태에 따른 이벤트 함수?
    /*!
     *  Updates the network host.
     *
     *      @param [in] _appTimeMS 
     */
    void Update(int64_t _appTimeMS);
    /*!
     *  Updates the listener.
     *
     *      @param [in] _appTimeMS 
     */
    void UpdateListener(int64_t _appTimeMS);
    /*!
     *  Updates the accepter.
     *
     *      @param [in] _appTimeMS 
     */
    void UpdateAccepter(int64_t _appTimeMS);
    /*!
     *  Updates the connector.
     *
     *      @param [in] _appTimeMS 
     */
    void UpdateConnector(int64_t _appTimeMS);

    /*!
     *  Events the connect.
     *
     *      @param [in] _type 
     */
    void EventConnect(const EHostType& _type);
    /*!
     *  Events the close.
     */
    void EventClose();
    /*!
     *  Events the receive.
     *
     *      @param [in]     _msgID   
     *      @param [in,out] _msg     
     *      @param [in]     _msgSize 
     */
    void EventReceive(int _msgID, char* _msg, int _msgSize);

public:
    const int& GetHostID() const;
    void SetHostID(const int& _id);

    SOCKET GetSocket();
    void SetSocket(SOCKET _sock);

    const EHostType& GetHostType() const;
    void SetHostType(const EHostType& _type);

    NetworkEventSync* GetEvnetSync();
    void SetEventSync(NetworkEventSync* _eventSync);

    std::string& GetIP();
    void SetIP(std::string _ip);
    int GetIPInt32();
    void SetIPInt32(int _n);

    int64_t GetLastPacketTick();
    int GetPeerPort();
    void SetPeerPort(const int& _port);

    void SetClientHostMode(const bool& _onoff);



private:
    /*!
     *  ESocketCloseType에 따른 메세지를 반환한다
     *
     *      @param [in] _e 
     *
     *      @return The socket close type string.
     */
    std::wstring _GetSocketCloseTypeString(const ESocketCloseType& _e);

    /*!
     *  NetworkHost 타입에 따른 메세지를 반환
     *
     *      @param [in] _type 
     *
     *      @return The host type.
     */
    const wchar_t* _GetHostType(const EHostType& _type);

    /*!
     *  Returns the network host's recv history stack string.
     */
    void _GetRecvHistoryStackString();

    /*!
     *  수신한 network 패킷 이력들을 반환한다
     *
     *      @param [in,out] _list 
     */
    void _GetRecvHistory(std::vector<std::tuple<int, int64_t>>& _list);

    /*!
     *  네트워크 패킷 수신된 데이터를 기록한다 (로그 성격)
     *
     *      @param [in] _msgID 
     *      @param [in] _tick  
     */
    void _AddReceive(const int& _msgID, const int64_t& _tick);
};

